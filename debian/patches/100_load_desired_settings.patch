diff -Nur gnome-desktop-2.25.4.orig/libgnome-desktop/gnome-rr-config.c gnome-desktop-2.25.4/libgnome-desktop/gnome-rr-config.c
--- gnome-desktop-2.25.4.orig/libgnome-desktop/gnome-rr-config.c	2009-01-15 11:00:52.000000000 +0100
+++ gnome-desktop-2.25.4/libgnome-desktop/gnome-rr-config.c	2009-01-15 16:44:06.000000000 +0100
@@ -34,6 +34,7 @@
 #include "edid.h"
 
 #define CONFIG_BASENAME "monitors.xml"
+#define CONFIG_DESIRED_BASENAME "monitors.xml.desired"
 
 /* In version 0 of the config file format, we had several <configuration>
  * toplevel elements and no explicit version number.  So, the filed looked
@@ -80,6 +81,10 @@
 static gchar *get_old_config_filename (void);
 static gchar *get_config_filename (void);
 
+static gboolean        gnome_rr_config_save_to_file (GnomeRRConfig *configuration,
+                       GError **err, gchar *filename);
+static void            remove_desired_settings      (void);
+
 typedef struct Parser Parser;
 
 /* Parser for monitor configurations */
@@ -396,7 +401,16 @@
 	NULL, /* passthrough */
 	NULL, /* error */
     };
-
+	
+	/* return NULL if the file doesn't exist */
+	if (!g_file_test (filename, G_FILE_TEST_EXISTS))
+    {
+	result = NULL;
+	
+	return result;
+    }
+	
+	
     parser->config_file_version = 0;
     parser->configurations = g_ptr_array_new ();
     parser->outputs = g_ptr_array_new ();
@@ -924,11 +938,71 @@
 }
 
 static gchar *
+get_desired_config_filename (void)
+{
+    return g_build_filename (g_get_user_config_dir (), CONFIG_DESIRED_BASENAME, NULL);
+}
+
+static gchar *
 get_config_filename (void)
 {
     return g_build_filename (g_get_user_config_dir (), CONFIG_BASENAME, NULL);
 }
 
+static GnomeRRConfig **
+desired_configurations_read (GError **error)
+{
+    char *filename;
+    GnomeRRConfig **configs;
+    GError *err;
+
+    /* Try the desired configuration file... */
+
+    filename = get_desired_config_filename ();
+    
+#if 0
+    g_debug("desired is = %s\n", filename);
+#endif
+    err = NULL;
+
+#if 0
+    g_debug("reading configuration...\n");
+#endif
+    configs = configurations_read_from_file (filename, &err);
+
+    g_free (filename);
+    
+#if 0
+    g_debug("done\n");
+#endif
+    if (err)
+    {
+        if (g_error_matches (err, G_FILE_ERROR, G_FILE_ERROR_NOENT))
+        {
+            
+#if 0
+            g_debug("error MATCHES\n");
+#endif
+            g_error_free (err);
+            
+            /* Okay, so try the old configuration file */
+            filename = get_config_filename ();
+            configs = configurations_read_from_file (filename, error);
+            g_free (filename);
+        }
+        else
+        {
+#if 0
+            g_debug("error does NOT MATCH\n");
+#endif
+            g_propagate_error (error, err);
+        }
+    }
+    
+    return configs;
+}
+
+
 static const char *
 get_rotation_name (GnomeRRRotation r)
 {
@@ -1050,13 +1124,12 @@
 }
 
 
-gboolean
-gnome_rr_config_save (GnomeRRConfig *configuration, GError **error)
+static gboolean
+gnome_rr_config_save_to_file (GnomeRRConfig *configuration, GError **error, gchar *filename)
 {
     GnomeRRConfig **configurations;
     GString *output;
     int i;
-    gchar *filename;
     gboolean result;
 
     g_return_val_if_fail (configuration != NULL, FALSE);
@@ -1101,6 +1174,37 @@
     return result;
 }
 
+gboolean
+gnome_rr_config_save (GnomeRRConfig *configuration, GError **err)
+{
+    gchar *filename;
+    filename = get_config_filename ();
+    
+    return(gnome_rr_config_save_to_file(configuration, err, filename));
+}
+
+gboolean
+ubuntu_gnome_rr_config_save_desired (GnomeRRConfig *configuration, GError **err)
+{
+    gchar *filename;
+    filename = get_desired_config_filename ();
+    
+    return(gnome_rr_config_save_to_file(configuration, err, filename));
+}
+
+static void
+remove_desired_settings(void)
+{
+    gchar *filename;
+    filename = get_desired_config_filename ();
+    if (g_file_test (filename, G_FILE_TEST_EXISTS))
+        g_unlink (filename);
+
+    g_free (filename);
+
+}
+
+
 static GnomeRRConfig *
 gnome_rr_config_copy (GnomeRRConfig *config)
 {
@@ -1119,6 +1223,48 @@
     return copy;
 }
 
+static GnomeRRConfig *
+gnome_rr_desired_config_new_stored (GnomeRRScreen *screen, GError **error)
+{
+    GnomeRRConfig *current;
+    GnomeRRConfig **configs;
+    GnomeRRConfig *result;
+
+    g_return_val_if_fail (screen != NULL, NULL);
+    g_return_val_if_fail (error == NULL || *error == NULL, NULL);
+    
+    current = gnome_rr_config_new_current (screen);
+    
+    configs = desired_configurations_read (error);
+
+    result = NULL;
+    if (configs)
+    {
+	int i;
+	
+	for (i = 0; configs[i] != NULL; ++i)
+	{
+	    if (gnome_rr_config_match (configs[i], current))
+	    {
+		result = gnome_rr_config_copy (configs[i]);
+		break;
+	    }
+	}
+
+	/*
+	if (result == NULL)
+	    g_set_error (error, GNOME_RR_ERROR, GNOME_RR_ERROR_NO_MATCHING_CONFIG,
+			 _("none of the saved display configurations matched the active configuration"));
+	*/
+
+	configurations_free (configs);
+    }
+
+    gnome_rr_config_free (current);
+    
+    return result;
+}
+
 GnomeRRConfig *
 gnome_rr_config_new_stored (GnomeRRScreen *screen, GError **error)
 {
@@ -1147,9 +1293,11 @@
 	    }
 	}
 
+	/*
 	if (result == NULL)
 	    g_set_error (error, GNOME_RR_ERROR, GNOME_RR_ERROR_NO_MATCHING_CONFIG,
 			 _("none of the saved display configurations matched the active configuration"));
+	*/
 
 	configurations_free (configs);
     }
@@ -1187,10 +1335,68 @@
     return result;
 }
 
+void
+ubuntu_compute_virtual_size_for_configuration (GnomeRRConfig *config, int *ret_width, int *ret_height)
+{
+    int i;
+    int width, height;
+
+    width = height = 0;
+
+    for (i = 0; config->outputs[i] != NULL; i++)
+    {
+	GnomeOutputInfo *output;
+
+	output = config->outputs[i];
+
+	if (output->on)
+	{
+	    width = MAX (width, output->x + output->width);
+	    height = MAX (height, output->y + output->height);
+	}
+    }
+
+    *ret_width = width;
+    *ret_height = height;
+}
+
+static gboolean
+check_framebuffer_size (GnomeRRConfig *config, GnomeRRScreen *screen)
+{
+    int req_width, req_height;
+    int min_width, max_width;
+    int min_height, max_height;
+    
+    /* Put the desired configuration 
+     * instead of app->current_configuration
+     */
+    ubuntu_compute_virtual_size_for_configuration (config, &req_width, &req_height);
+    
+    /* Put screen 
+     * instead of app->screen
+     */
+    gnome_rr_screen_get_ranges (screen, &min_width, &max_width, &min_height, &max_height);
+
+#if 0
+    g_debug ("X Server supports:\n");
+    g_debug ("min_width = %d, max_width = %d\n", min_width, max_width);
+    g_debug ("min_height = %d, max_height = %d\n", min_height, max_height);
+
+    g_debug ("Requesting size of %dx%d\n", req_width, req_height);
+#endif
+
+    if (!(min_width <= req_width && req_width <= max_width
+	  && min_height <= req_height && req_height <= max_height))
+        return FALSE;
+    else
+        return TRUE;
+}
+
 gboolean
 gnome_rr_config_apply_stored (GnomeRRScreen *screen, GError **error)
 {
     GnomeRRConfig *stored;
+    gboolean is_desired = FALSE;
     GError *my_error;
 
     g_return_val_if_fail (screen != NULL, FALSE);
@@ -1206,22 +1412,68 @@
 	    /* This means the screen didn't change, so just proceed */
     }
 
-    stored = gnome_rr_config_new_stored (screen, error);
-
-    if (stored)
-    {
-	gboolean result;
-
-	result = gnome_rr_config_apply (stored, screen, error);
-
-	gnome_rr_config_free (stored);
-	
-	return result;
+    /* Look for the desired settings and try to load that
+     * instead.
+     * Then remove such settings.
+     * else read the usual configuration
+     */
+    gchar *filename;
+    filename = get_desired_config_filename ();
+    
+    /* If the desired file exists */
+    if ((g_file_test(filename, G_FILE_TEST_EXISTS))) {
+        stored = gnome_rr_desired_config_new_stored (screen, error);
+        
+        /* If the desired file can't be applied */
+        if (!stored) {
+            stored = gnome_rr_config_new_stored (screen, error);
+        }
+        else {
+            /* the desired file is valid and 
+               can be applied */
+            is_desired = TRUE;
+        }
+    }
+    /* If the desired file does not exist */
+    else {
+        stored = gnome_rr_config_new_stored (screen, error);
+    }
+
+    /* remove desired */
+	remove_desired_settings();
+	
+    if (stored) {
+    	gboolean result = FALSE;
+        
+        /* Check framebuffer size. Do not apply
+	     * the settings if the fb is not big
+	     * enough
+	     */
+        if (check_framebuffer_size (stored, screen)) {
+        
+        	result = gnome_rr_config_apply (stored, screen, error);
+
+        	/* if we are using the desired settings and
+        	   the settings were applied successfully */
+        	if (is_desired && result) {
+                /* Try to save the desired settings to the default
+                 * settings file
+                 */
+                error = NULL;
+                gnome_rr_config_sanitize (stored);
+                gnome_rr_config_save (stored, &error);
+        	}
+    	
+    	}
+    	
+    	gnome_rr_config_free (stored);
+    	
+    	return result;
     }
-    else
-    {
-	return FALSE;
+    else {
+	    return FALSE;
     }
+
 }
 
 /*
diff -Nur gnome-desktop-2.25.4.orig/libgnome-desktop/libgnomeui/gnome-rr-config.h gnome-desktop-2.25.4/libgnome-desktop/libgnomeui/gnome-rr-config.h
--- gnome-desktop-2.25.4.orig/libgnome-desktop/libgnomeui/gnome-rr-config.h	2009-01-15 11:00:52.000000000 +0100
+++ gnome-desktop-2.25.4/libgnome-desktop/libgnomeui/gnome-rr-config.h	2009-01-15 13:28:21.000000000 +0100
@@ -92,6 +92,11 @@
 					      GnomeRRScreen  *screen,
 					      GError        **error);
 
+gboolean        ubuntu_gnome_rr_config_save_desired (GnomeRRConfig *configuration,
+                        GError **err);
+void            ubuntu_compute_virtual_size_for_configuration (GnomeRRConfig *config,
+                          int *ret_width, int *ret_height);
+                          
 /* A utility function that isn't really in the spirit of this file, but I don't
  * don't know a better place for it.
  */
